<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Updates</title>
    
    <style>
        /* 
        CSS STYLES - This controls how everything looks
        You can change colors, sizes, spacing here
        */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "OCR A Std", "Courier New", monospace;
            background-color: #f5f5f5;  /* Light gray background */
            padding: 20px;
            max-width: 800px;  /* Keep content centered and not too wide */
            margin: 0 auto;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        
        /* LOGIN FORM STYLES */
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 100px auto;
        }
        
        .login-container h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        input[type="text"],
        input[type="password"],
        textarea {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background-color: #4CAF50;  /* Green - change this color if you want */
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px 0;
        }
        
        button:hover {
            background-color: #45a049;  /* Slightly darker when you hover */
        }
        
        .logout-btn {
            background-color: #f44336;  /* Red for logout */
        }
        
        /* POST CREATION AREA */
        .create-post {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .create-post textarea {
            min-height: 80px;
            resize: vertical;  /* Let user resize height */
        }
        
        /* INDIVIDUAL POST STYLES */
        .post {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .post-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #666;
            font-size: 14px;
        }
        
        .post-content {
            margin: 15px 0;
            line-height: 1.6;
            color: #333;
        }
        
        /* REACTIONS (emoji buttons) */
        .reactions {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            padding: 10px 0;
            border-top: 1px solid #eee;
        }
        
        .reaction-btn {
            background: #f0f0f0;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .reaction-btn:hover {
            background: #e0e0e0;
        }
        
        .reaction-btn.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        /* COMMENTS SECTION */
        .comments {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .comment {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .comment-header {
            font-weight: bold;
            color: #555;
            font-size: 13px;
            margin-bottom: 5px;
        }
        
        .comment-text {
            color: #333;
            font-size: 14px;
        }
        
        .comment-form {
            margin-top: 10px;
        }
        
        .comment-form input {
            width: calc(100% - 100px);
            display: inline-block;
        }
        
        .comment-form button {
            width: 90px;
            display: inline-block;
        }
        
        /* HEADER BAR when logged in */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .hidden {
            display: none;
        }
        
        .error {
            color: #f44336;
            font-size: 14px;
            margin-top: 10px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    
    <!-- 
    LOGIN SCREEN - shown when user is not logged in 
    This section is hidden once user logs in
    -->
    <div id="loginScreen" class="login-container">
        <h2>Family Updates</h2>
        <p style="color: #666; margin-bottom: 20px;">Sign in to share updates with family</p>
        
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()">Login</button>
        <button onclick="showRegister()">Create Account</button>
        <div id="loginError" class="error"></div>
    </div>
    
    <!-- 
    MAIN APP - shown when user is logged in 
    Contains post creation, feed, etc.
    -->
    <div id="mainApp" class="hidden">
        
        <!-- Header with user info and logout -->
        <div class="header">
            <div>
                <h1>Family Updates</h1>
                <p style="color: #666;">Welcome, <span id="currentUser"></span>!</p>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
        
        <!-- Create new post section -->
        <div class="create-post">
            <h3>Share an Update</h3>
            <textarea id="newPostContent" placeholder="What's happening with you?"></textarea>
            <button onclick="createPost()">Post Update</button>
        </div>
        
        <!-- Feed where all posts appear -->
        <div id="feed">
            <div class="loading">Loading posts...</div>
        </div>
    </div>

    <!-- 
    FIREBASE SETUP
    These script tags import Firebase libraries from the internet
    We're using version 9 of Firebase (the modular version)
    -->
    <script type="module">
        // Import Firebase functions we need
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, query, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        /*
        FIREBASE CONFIGURATION
        This connects your website to YOUR specific Firebase project
        */
        const firebaseConfig = {
            apiKey: "AIzaSyBcLB4LtI3f7Xuxa4tMCxzcSG6Bi3XSaOI",
            authDomain: "snuketownusa.firebaseapp.com",
            projectId: "snuketownusa",
            storageBucket: "snuketownusa.firebasestorage.app",
            messagingSenderId: "294126465212",
            appId: "1:294126465212:web:55e21ba84523144eafa0b9",
            measurementId: "G-JPKN8K2K9V"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        
        // Initialize Firestore (the database)
        const db = getFirestore(app);

        /*
        HOW FIREBASE FIRESTORE WORKS:
        
        Firestore is a "NoSQL database" - it stores data in "collections" and "documents"
        Think of it like this:
        - Collection = A folder (like "users" or "posts")
        - Document = A file in that folder (like a specific user or post)
        
        We'll have two collections:
        1. "users" - stores usernames and passwords
        2. "posts" - stores all the posts, comments, reactions
        
        Unlike localStorage (which only saves on YOUR computer), 
        Firestore saves to the cloud so EVERYONE sees the same data!
        */

        // Make Firebase functions available globally so our other functions can use them
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.updateDoc = updateDoc;
        window.doc = doc;
        window.query = query;
        window.orderBy = orderBy;
        window.onSnapshot = onSnapshot;

        // Start the app once Firebase is ready
        window.onload = function() {
            if (getCurrentUser()) {
                showMainApp();
            }
        };
    </script>

    <script>
        /*
        JAVASCRIPT CODE - This makes everything interactive
        Now using Firebase instead of localStorage!
        */
        
        // Get current user from localStorage (we still store who's logged in locally)
        function getCurrentUser() {
            return localStorage.getItem('currentUser');
        }
        
        /*
        LOGIN FUNCTION
        Now checks against Firebase database instead of localStorage
        */
        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            // Check if fields are empty
            if (!username || !password) {
                errorDiv.textContent = 'Please enter username and password';
                return;
            }
            
            try {
                // Get all users from Firebase
                const usersRef = collection(db, 'users');
                const querySnapshot = await getDocs(usersRef);
                
                // Check if username and password match
                let userFound = false;
                querySnapshot.forEach((doc) => {
                    const user = doc.data();
                    if (user.username === username && user.password === password) {
                        userFound = true;
                    }
                });
                
                if (userFound) {
                    // Success! Save current user and show main app
                    localStorage.setItem('currentUser', username);
                    showMainApp();
                    errorDiv.textContent = '';
                } else {
                    errorDiv.textContent = 'Invalid username or password';
                }
            } catch (error) {
                console.error("Error logging in:", error);
                errorDiv.textContent = 'Error logging in. Please try again.';
            }
        }
        
        /*
        REGISTRATION FUNCTION
        Now saves to Firebase instead of localStorage
        */
        async function showRegister() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            if (!username || !password) {
                errorDiv.textContent = 'Please enter username and password';
                return;
            }
            
            try {
                // Check if username already exists
                const usersRef = collection(db, 'users');
                const querySnapshot = await getDocs(usersRef);
                
                let usernameExists = false;
                querySnapshot.forEach((doc) => {
                    if (doc.data().username === username) {
                        usernameExists = true;
                    }
                });
                
                if (usernameExists) {
                    errorDiv.textContent = 'Username already exists';
                    return;
                }
                
                // Create new user in Firebase
                await addDoc(collection(db, 'users'), {
                    username: username,
                    password: password,
                    createdAt: new Date()
                });
                
                errorDiv.textContent = '';
                errorDiv.style.color = '#4CAF50';
                errorDiv.textContent = 'Account created! You can now login.';
                
                // Clear password field
                document.getElementById('password').value = '';
            } catch (error) {
                console.error("Error creating account:", error);
                errorDiv.textContent = 'Error creating account. Please try again.';
            }
        }
        
        /*
        LOGOUT FUNCTION
        */
        function logout() {
            localStorage.removeItem('currentUser');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }
        
        /*
        SHOW MAIN APP
        Switches from login screen to main app
        */
        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('currentUser').textContent = getCurrentUser();
            listenToPosts(); // Start listening for real-time updates!
        }
        
        /*
        CREATE A NEW POST
        Now saves to Firebase!
        */
        async function createPost() {
            const content = document.getElementById('newPostContent').value.trim();
            
            if (!content) {
                alert('Please write something!');
                return;
            }
            
            try {
                // Add new post to Firebase
                await addDoc(collection(db, 'posts'), {
                    author: getCurrentUser(),
                    content: content,
                    timestamp: new Date(),
                    reactions: {},  // Object to store reactions
                    comments: []    // Array to store comments
                });
                
                // Clear the text box
                document.getElementById('newPostContent').value = '';
                
                // No need to manually refresh - onSnapshot will auto-update!
                
            } catch (error) {
                console.error("Error creating post:", error);
                alert('Error creating post. Please try again.');
            }
        }
        
        /*
        LISTEN TO POSTS IN REAL-TIME
        This is the magic of Firebase! 
        onSnapshot listens for changes and automatically updates the page
        whenever anyone adds/edits a post - no refresh needed!
        */
        function listenToPosts() {
            const postsRef = collection(db, 'posts');
            const q = query(postsRef, orderBy('timestamp', 'desc'));
            
            // onSnapshot fires every time the data changes
            onSnapshot(q, (querySnapshot) => {
                const posts = [];
                querySnapshot.forEach((doc) => {
                    posts.push({
                        id: doc.id,  // Firebase document ID
                        ...doc.data()  // All the post data
                    });
                });
                displayPosts(posts);
            });
        }
        
        /*
        DISPLAY ALL POSTS
        Same as before, but now receives posts from Firebase
        */
        function displayPosts(posts) {
            const feed = document.getElementById('feed');
            const currentUser = getCurrentUser();
            
            // Clear existing posts
            feed.innerHTML = '';
            
            if (posts.length === 0) {
                feed.innerHTML = '<div class="loading">No posts yet. Be the first to share!</div>';
                return;
            }
            
            // Create HTML for each post
            posts.forEach(post => {
                const postDiv = document.createElement('div');
                postDiv.className = 'post';
                
                // Count reactions
                const reactions = post.reactions || {};
                const reactionCounts = {};
                Object.values(reactions).forEach(emoji => {
                    reactionCounts[emoji] = (reactionCounts[emoji] || 0) + 1;
                });
                
                // Build reactions display
                let reactionsHTML = '';
                ['ðŸ‘', 'â¤ï¸', 'ðŸ˜‚', 'ðŸŽ‰'].forEach(emoji => {
                    const count = reactionCounts[emoji] || 0;
                    const isActive = reactions[currentUser] === emoji;
                    const activeClass = isActive ? 'active' : '';
                    reactionsHTML += `
                        <button class="reaction-btn ${activeClass}" onclick="toggleReaction('${post.id}', '${emoji}')">
                            ${emoji} ${count > 0 ? count : ''}
                        </button>
                    `;
                });
                
                // Build comments display
                let commentsHTML = '<div class="comments">';
                (post.comments || []).forEach(comment => {
                    commentsHTML += `
                        <div class="comment">
                            <div class="comment-header">${comment.author}</div>
                            <div class="comment-text">${comment.text}</div>
                        </div>
                    `;
                });
                
                // Add comment form
                commentsHTML += `
                    <div class="comment-form">
                        <input type="text" id="comment-${post.id}" placeholder="Write a comment...">
                        <button onclick="addComment('${post.id}')">Comment</button>
                    </div>
                </div>
                `;
                
                // Format timestamp
                const timestamp = post.timestamp?.toDate ? 
                    post.timestamp.toDate().toLocaleString() : 
                    'Just now';
                
                // Put it all together
                postDiv.innerHTML = `
                    <div class="post-header">
                        <strong>${post.author}</strong>
                        <span>${timestamp}</span>
                    </div>
                    <div class="post-content">${post.content}</div>
                    <div class="reactions">
                        ${reactionsHTML}
                    </div>
                    ${commentsHTML}
                `;
                
                feed.appendChild(postDiv);
            });
        }
        
        /*
        TOGGLE REACTION
        Now updates Firebase
        */
        async function toggleReaction(postId, emoji) {
            const currentUser = getCurrentUser();
            
            try {
                // Get the current post data
                const postRef = doc(db, 'posts', postId);
                const postSnap = await getDocs(collection(db, 'posts'));
                
                let currentReactions = {};
                postSnap.forEach((document) => {
                    if (document.id === postId) {
                        currentReactions = document.data().reactions || {};
                    }
                });
                
                // Toggle the reaction
                if (currentReactions[currentUser] === emoji) {
                    delete currentReactions[currentUser];
                } else {
                    currentReactions[currentUser] = emoji;
                }
                
                // Update in Firebase
                await updateDoc(postRef, {
                    reactions: currentReactions
                });
                
                // onSnapshot will automatically refresh the display!
                
            } catch (error) {
                console.error("Error toggling reaction:", error);
            }
        }
        
        /*
        ADD COMMENT
        Now saves to Firebase
        */
        async function addComment(postId) {
            const commentInput = document.getElementById(`comment-${postId}`);
            const commentText = commentInput.value.trim();
            
            if (!commentText) {
                return;
            }
            
            try {
                // Get current comments
                const postSnap = await getDocs(collection(db, 'posts'));
                
                let currentComments = [];
                postSnap.forEach((document) => {
                    if (document.id === postId) {
                        currentComments = document.data().comments || [];
                    }
                });
                
                // Add new comment
                currentComments.push({
                    author: getCurrentUser(),
                    text: commentText,
                    timestamp: new Date()
                });
                
                // Update in Firebase
                const postRef = doc(db, 'posts', postId);
                await updateDoc(postRef, {
                    comments: currentComments
                });
                
                // Clear input
                commentInput.value = '';
                
                // onSnapshot will automatically refresh the display!
                
            } catch (error) {
                console.error("Error adding comment:", error);
            }
        }
    </script>
    
</body>
</html>
